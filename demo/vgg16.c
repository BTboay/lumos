#include "vgg16.h"

void vgg16(char *type, char *path)
{
    Graph *g = create_graph();
    Layer *l1 = make_convolutional_layer(64, 3, 1, 1, 1, 0, "relu");
    Layer *l2 = make_convolutional_layer(64, 3, 1, 1, 1, 0, "relu");
    Layer *l3 = make_maxpool_layer(2, 2, 0);
    Layer *l4 = make_convolutional_layer(128, 3, 1, 1, 1, 0, "relu");
    Layer *l5 = make_convolutional_layer(128, 3, 1, 1, 1, 0, "relu");
    Layer *l6 = make_maxpool_layer(2, 2, 0);
    Layer *l7 = make_convolutional_layer(256, 3, 1, 1, 1, 0, "relu");
    Layer *l8 = make_convolutional_layer(256, 3, 1, 1, 1, 0, "relu");
    Layer *l9 = make_convolutional_layer(256, 3, 1, 1, 1, 0, "relu");
    Layer *l10 = make_maxpool_layer(2, 2, 0);
    Layer *l11 = make_convolutional_layer(512, 3, 1, 1, 1, 0, "relu");
    Layer *l12 = make_convolutional_layer(512, 3, 1, 1, 1, 0, "relu");
    Layer *l13 = make_convolutional_layer(512, 3, 1, 1, 1, 0, "relu");
    Layer *l14 = make_maxpool_layer(2, 2, 0);
    Layer *l15 = make_convolutional_layer(512, 3, 1, 1, 1, 0, "relu");
    Layer *l16 = make_convolutional_layer(512, 3, 1, 1, 1, 0, "relu");
    Layer *l17 = make_convolutional_layer(512, 3, 1, 1, 1, 0, "relu");
    Layer *l18 = make_maxpool_layer(2, 2, 0);
    Layer *l19 = make_im2col_layer();
    Layer *l20 = make_connect_layer(4096, 1, "relu");
    Layer *l21 = make_dropout_layer(0.5);
    Layer *l22 = make_connect_layer(4096, 1, "relu");
    Layer *l23 = make_dropout_layer(0.5);
    Layer *l24 = make_connect_layer(1000, 1, "linear");
    Layer *l25 = make_softmax_layer(1000);
    Layer *l26 = make_mae_layer(1000);
    append_layer2grpah(g, l1);
    append_layer2grpah(g, l2);
    append_layer2grpah(g, l3);
    append_layer2grpah(g, l4);
    append_layer2grpah(g, l5);
    append_layer2grpah(g, l6);
    append_layer2grpah(g, l7);
    append_layer2grpah(g, l8);
    append_layer2grpah(g, l9);
    append_layer2grpah(g, l10);
    append_layer2grpah(g, l11);
    append_layer2grpah(g, l12);
    append_layer2grpah(g, l13);
    append_layer2grpah(g, l14);
    append_layer2grpah(g, l15);
    append_layer2grpah(g, l16);
    append_layer2grpah(g, l17);
    append_layer2grpah(g, l18);
    append_layer2grpah(g, l19);
    append_layer2grpah(g, l20);
    append_layer2grpah(g, l21);
    append_layer2grpah(g, l22);
    append_layer2grpah(g, l23);
    append_layer2grpah(g, l24);
    append_layer2grpah(g, l25);
    append_layer2grpah(g, l26);
    Session *sess = create_session(g, 256, 256, 3, 1000, type, path);
    set_train_params(sess, 200, 16, 16, 0.001);
    init_session(sess, "./data/fmnist/train.txt", "./data/fmnist/train_label.txt");
    train(sess, 0);
}

void vgg16_detect(char*type, char *path)
{
    Graph *g = create_graph();
    Layer *l1 = make_convolutional_layer(64, 3, 1, 1, 1, 0, "relu");
    Layer *l2 = make_convolutional_layer(64, 3, 1, 1, 1, 0, "relu");
    Layer *l3 = make_maxpool_layer(2, 2, 0);
    Layer *l4 = make_convolutional_layer(128, 3, 1, 1, 1, 0, "relu");
    Layer *l5 = make_convolutional_layer(128, 3, 1, 1, 1, 0, "relu");
    Layer *l6 = make_maxpool_layer(2, 2, 0);
    Layer *l7 = make_convolutional_layer(256, 3, 1, 1, 1, 0, "relu");
    Layer *l8 = make_convolutional_layer(256, 3, 1, 1, 1, 0, "relu");
    Layer *l9 = make_convolutional_layer(256, 3, 1, 1, 1, 0, "relu");
    Layer *l10 = make_maxpool_layer(2, 2, 0);
    Layer *l11 = make_convolutional_layer(512, 3, 1, 1, 1, 0, "relu");
    Layer *l12 = make_convolutional_layer(512, 3, 1, 1, 1, 0, "relu");
    Layer *l13 = make_convolutional_layer(512, 3, 1, 1, 1, 0, "relu");
    Layer *l14 = make_maxpool_layer(2, 2, 0);
    Layer *l15 = make_convolutional_layer(512, 3, 1, 1, 1, 0, "relu");
    Layer *l16 = make_convolutional_layer(512, 3, 1, 1, 1, 0, "relu");
    Layer *l17 = make_convolutional_layer(512, 3, 1, 1, 1, 0, "relu");
    Layer *l18 = make_maxpool_layer(2, 2, 0);
    Layer *l19 = make_connect_layer(4096, 1, "relu");
    Layer *l20 = make_dropout_layer(0.5);
    Layer *l21 = make_connect_layer(4096, 1, "relu");
    Layer *l22 = make_dropout_layer(0.5);
    Layer *l23 = make_connect_layer(1000, 1, "linear");
    Layer *l24 = make_softmax_layer(1000);
    Layer *l25 = make_mae_layer(1000);
    append_layer2grpah(g, l1);
    append_layer2grpah(g, l2);
    append_layer2grpah(g, l3);
    append_layer2grpah(g, l4);
    append_layer2grpah(g, l5);
    append_layer2grpah(g, l6);
    append_layer2grpah(g, l7);
    append_layer2grpah(g, l8);
    append_layer2grpah(g, l9);
    append_layer2grpah(g, l10);
    append_layer2grpah(g, l11);
    append_layer2grpah(g, l12);
    append_layer2grpah(g, l13);
    append_layer2grpah(g, l14);
    append_layer2grpah(g, l15);
    append_layer2grpah(g, l16);
    append_layer2grpah(g, l17);
    append_layer2grpah(g, l18);
    append_layer2grpah(g, l19);
    append_layer2grpah(g, l20);
    append_layer2grpah(g, l21);
    append_layer2grpah(g, l22);
    append_layer2grpah(g, l23);
    append_layer2grpah(g, l24);
    append_layer2grpah(g, l25);
    Session *sess = create_session(g, 256, 256, 3, 1000, type, path);
    set_detect_params(sess);
    init_session(sess, "./data/fmnist/test.txt", "./data/fmnist/test_label.txt");
    train(sess, 0);
}
